<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - NotesPortal</title>
    <link rel="stylesheet" href="/css/chapters.css">

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>




    <header class="navbar">
        <a href="/" class="logo">NotesPortal</a>

        <ul class="nav-links desktop-nav">
            <li><a href="/">Home</a></li>
            <li><a href="/#motive">Our Motive</a></li>
            <li><a href="/#contact">Contact</a></li>

            <th:block sec:authorize="!isAuthenticated()">
                <li><a href="/login" class="btn-login">Login</a></li>
                <li class="profile-link-li">
                    <div class="profile-icon-placeholder">
                        <img src="/images/person-icon.png" alt="Profile">
                    </div>
                </li>
            </th:block>

            <th:block sec:authorize="isAuthenticated()">
                <li><a href="/logout" class="btn-logout">Logout</a></li>
                <li class="profile-link-li">
                    <a href="/dashboard" class="profile-link">
                        <img src="/images/person-icon.png" alt="Profile">
                    </a>
                </li>
            </th:block>
        </ul>

        <div class="mobile-nav-container">
            <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="mobile-profile-icon">
                <img src="/images/person-icon.png" alt="Login">
            </a>

            <div class="dropdown-wrapper" sec:authorize="isAuthenticated()">
                <button class="mobile-profile-icon" id="mobileProfileBtn">
                    <img src="/images/person-icon.png" alt="Profile">
                </button>
                <ul class="mobile-dropdown" id="mobileDropdown">
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="#hero">Home</a></li>
                    <li><a href="#motive">Our Motive</a></li>
                    <li><a href="#contact">Contact</a></li>
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div id="loading-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: sans-serif;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold;">Processing Payment... Please wait.</p>
    </div>

    <main class="chapters-container">
        <h1 class="page-title">Notes</h1>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search notes..." onkeyup="filterNotes()">
        </div>


        <div id="alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 1050;"></div>

        <div class="chapters-grid">
            <div th:if="${#lists.isEmpty(notes)}" class="chapter-card no-chapter">
                <p>No Notes Available</p>
            </div>

            <div th:each="note : ${notes}" class="chapter-card">
                <h2 class="chapter-title" th:text="${note.title}">Note Title</h2>

                <div class="note-actions">
                    <div sec:authorize="isAuthenticated()">

                        <div th:if="${note.isFree} or ${userHasNote.get(note.id)}">
                            <a th:href="@{'https://lksdahsyqqcmrvcjyxkn.supabase.co/storage/v1/object/public/BucketForNotes/' + ${note.fileUrl}}"
                                class="btn-open unlocked" target="_blank" download>
                                Download PDF
                            </a>
                        </div>


                        <div th:if="${!note.free} and !${userHasNote.get(note.id)}">

                            <button type="button" class="btn-open pay-button"
                                th:attr="data-note-id=${note.id}, data-price=${note.price}, data-note-title=${note.title}"
                                onclick="payForNote(this)">
                                Pay â‚¹<span th:text="${note.price}"></span>
                            </button>
                        </div>
                    </div>

                    <div sec:authorize="!isAuthenticated()">
                        <a th:if="${note.free}"
                            th:href="@{'https://lksdahsyqqcmrvcjyxkn.supabase.co/storage/v1/object/public/BucketForNotes/' + ${note.fileUrl}}"
                            taget="_blank" class="btn-open unlocked" download>Download</a>

                        <a th:unless="${note.free}" href="/login" class="btn-open locked disabled">Login to Buy ðŸ”’</a>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            const mobileBtn = document.getElementById('mobileProfileBtn');
            const mobileMenu = document.getElementById('mobileDropdown');

            // Toggle mobile dropdown
            if (mobileBtn) {
                mobileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('active');
                });
            }

            // Smooth scroll and auto-close menu
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Close menu if open
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                    }

                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                if (mobileMenu && mobileMenu.classList.contains('active')) {
                    mobileMenu.classList.remove('active');
                }
            });
        });


        const currentUser = {
            name: '[[${#authentication != null ? (#authentication.principal instanceof T(java.lang.String) ? #authentication.principal : #authentication.principal?.username) : ""}]]',
            email: '[[${#authentication != null ? (#authentication.principal instanceof T(java.lang.String) ? #authentication.principal : #authentication.principal?.username) : ""}]]'
        };




        const razorpaykey = /*[[${razorpayKey}]]*/ 'fallback-key';







        window.payForNote = async function (button) {
            const overlay = document.getElementById('loading-overlay');

            // 1. Show the loading overlay
            overlay.style.display = 'flex';

            try {
                const noteId = Number(button.getAttribute('data-note-id'));
                const noteTitle = button.getAttribute('data-note-title');

                const response = await fetch('/payment/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noteId })
                });

                if (!response.ok) {
                    overlay.style.display = 'none'; // Hide if failed
                    showAlert('Could not create payment order. Please try again.', 'error');
                    return;
                }

                const orderData = await response.json();

                const options = {
                    key: razorpaykey,
                    amount: orderData.amount,
                    currency: "INR",
                    name: "NotesPortal",
                    description: "Purchase: " + noteTitle,
                    order_id: orderData.id,
                    modal: {
                        ondismiss: function () {
                            // Hide overlay if user closes the Razorpay popup
                            overlay.style.display = 'none';
                        }
                    },
                    handler: async function (response) {
                        // Keep overlay visible during verification
                        const verificationResponse = await fetch('/payment/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature,
                                noteId: noteId
                            })
                        });

                        const verificationResult = await verificationResponse.json();
                        overlay.style.display = 'none'; // Finally hide it

                        if (verificationResult.status === 'success') {
                            showAlert('Payment successful! You can now download the note.', 'success');
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                            showAlert('Payment verification failed. Please contact support.', 'error');
                        }
                    },
                    prefill: {
                        name: currentUser.name,
                        email: currentUser.email
                    },
                    theme: { color: "#3399cc" }
                };

                const rzp = new Razorpay(options);

                // 2. Hide overlay when the Razorpay modal actually opens
                rzp.on('payment.failed', function (response) {
                    overlay.style.display = 'none';
                    showAlert('Payment failed: ' + response.error.description, 'error');
                });

                rzp.open();

                // Optional: Hide overlay shortly after rzp.open() 
                // because the Razorpay UI is now visible.
                setTimeout(() => { overlay.style.display = 'none'; }, 1500);

            } catch (error) {
                overlay.style.display = 'none';
                console.error(error);
                showAlert('An unexpected error occurred.', 'error');
            }
        }


        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.style.padding = '15px';
            alertDiv.style.marginBottom = '10px';
            alertDiv.style.borderRadius = '5px';
            alertDiv.style.color = 'white';
            alertDiv.style.minWidth = '250px';
            alertDiv.style.opacity = '0.9';

            alertDiv.textContent = message;

            if (type === 'success') {
                alertDiv.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                alertDiv.style.backgroundColor = '#dc3545';
            } else {
                alertDiv.style.backgroundColor = '#17a2b8';
            }

            alertContainer.appendChild(alertDiv);


            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s';
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500);
            }, 5000);
        }

        function filterNotes() {
            const input = document.getElementById("search-input").value.toLowerCase();
            const cards = document.querySelectorAll(".chapter-card");
            cards.forEach(card => {
                const title = card.querySelector(".chapter-title").textContent.toLowerCase();
                card.style.display = title.includes(input) ? "" : "none";
            });
        }
    </script>

</body>

</html>